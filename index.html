<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Chat del Salón</title>
  <style>
    /* ===== Tema (oscuro por defecto) ===== */
    :root{
      --bg:#0b0b0c; --surface:#111214; --ink:#e5e7eb; --muted:#a1a1aa; --accent:#2563eb;
      --bot:#1a1b1e; --user:#2563eb; --border:#232428;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f7f7fb; --surface:#ffffff; --ink:#111827; --muted:#6b7280; --accent:#2563eb;
        --bot:#f3f4f6; --user:#2563eb; --border:#e5e7eb;
      }
    }
    .light{ /* fuerza claro */
      --bg:#f7f7fb; --surface:#ffffff; --ink:#111827; --muted:#6b7280; --accent:#2563eb;
      --bot:#f3f4f6; --user:#2563eb; --border:#e5e7eb;
    }
    .dark{  /* fuerza oscuro */
      --bg:#0b0b0c; --surface:#111214; --ink:#e5e7eb; --muted:#a1a1aa; --accent:#2563eb;
      --bot:#1a1b1e; --user:#2563eb; --border:#232428;
    }

    /* ===== Layout ===== */
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    .app{
      max-width:800px; margin:0 auto;
      padding-top:56px;                 /* alto del header */
      padding-bottom:calc(var(--foot-h,72px) + env(safe-area-inset-bottom)); /* deja espacio al footer fijo */
      height:100dvh;                    /* viewport real en móviles */
      box-sizing:border-box;
      display:flex; flex-direction:column;
    }
    .head{
      height:56px;
      position:fixed; top:0; left:0; right:0;
      background:var(--surface); border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between;
      padding:0 14px; box-sizing:border-box;
      max-width:800px; margin:0 auto;
      z-index:20;
    }
    .title{font-weight:700}
    .muted{color:var(--muted); font-size:12px}
    .toggle{
      border:1px solid var(--border); background:transparent; color:var(--ink);
      border-radius:999px; padding:6px 12px; font-weight:600; cursor:pointer;
    }

    .chat{
      flex:1; overflow:auto; padding:10px; gap:8px;
      display:flex; flex-direction:column;
      -webkit-overflow-scrolling: touch; /* scroll suave en iOS */
      scroll-behavior:auto;              /* controlamos manualmente */
      background:var(--bg);
      border-left:1px solid var(--border); border-right:1px solid var(--border);
    }
    .row{display:flex}
    .me{justify-content:flex-end}
    .bubble{
      max-width:82%; padding:10px 12px; border-radius:16px;
      font-size:15px; line-height:1.4; word-wrap:break-word;
      border:1px solid var(--border);
    }
    .bubble.bot{background:var(--bot); color:var(--ink); border-bottom-left-radius:6px}
    .bubble.me{background:var(--user); color:#fff; border-bottom-right-radius:6px}

    .chips{display:flex; flex-wrap:wrap; gap:8px; margin-top:4px}
    .chip{
      border:1px solid var(--border); background:transparent; color:var(--ink);
      border-radius:999px; padding:6px 10px; font-size:13px; cursor:pointer;
    }

    .foot{
      position:fixed; left:0; right:0; bottom:0;
      background:var(--surface); border-top:1px solid var(--border);
      padding:8px; padding-bottom:calc(8px + env(safe-area-inset-bottom));
      display:grid; grid-template-columns:1fr auto; gap:8px; box-sizing:border-box;
      max-width:800px; margin:0 auto; z-index:30;
    }
    .in{
      font-size:16px;                 /* 16px evita zoom en iOS */
      padding:12px 14px; border-radius:12px;
      border:1px solid var(--border); outline:none;
      color:var(--ink); background:transparent;
      width:100%; box-sizing:border-box;
    }
    .btn{
      font-size:16px; font-weight:700;
      padding:12px 16px; border-radius:12px; border:none;
      background:var(--accent); color:#fff; cursor:pointer;
    }
    .btn:active{transform:translateY(1px)}
  </style>
</head>
<body>
  <div class="head">
    <div>
      <div class="title">Chat del Salón</div>
      <div class="muted">Agenda, reprograma y resuelve dudas</div>
    </div>
    <button id="toggle" class="toggle">☾ / ☀︎</button>
  </div>

  <div class="app">
    <div id="chat" class="chat"></div>
  </div>

  <div class="foot" id="foot">
    <input id="input" class="in" placeholder="Escribe tu mensaje…" autocomplete="off" />
    <button id="send" class="btn">Enviar</button>
  </div>

  <script>
    /* ===== Tema claro/oscuro ===== */
    const saved = localStorage.getItem('theme');
    if(saved){ document.body.classList.add(saved); }
    else {
      const prefersDark = matchMedia('(prefers-color-scheme: dark)').matches;
      document.body.classList.add(prefersDark ? 'dark' : 'light');
    }
    document.getElementById('toggle').onclick = ()=>{
      const light = document.body.classList.contains('light');
      document.body.classList.remove(light ? 'light' : 'dark');
      document.body.classList.add(light ? 'dark' : 'light');
      localStorage.setItem('theme', light ? 'dark' : 'light');
    };

    /* ===== Layout dinámico: medir footer y mantenerlo visible ===== */
    const foot = document.getElementById('foot');
    const app  = document.querySelector('.app');
    function setFootVar(){
      const h = foot.getBoundingClientRect().height;
      document.documentElement.style.setProperty('--foot-h', h + 'px');
    }
    setFootVar();
    new ResizeObserver(setFootVar).observe(foot);

    /* ===== Chat ===== */
    const chat  = document.getElementById('chat');
    const input = document.getElementById('input');
    const send  = document.getElementById('send');

    function scrollToBottomSmooth(){
      // usar dos RAFs evita saltos en Safari cuando se acaba de insertar
      requestAnimationFrame(()=> {
        chat.scrollTop = chat.scrollHeight;
        requestAnimationFrame(()=> chat.scrollTop = chat.scrollHeight);
      });
    }

    function addMsg(text, who='bot'){
      const row = document.createElement('div');
      row.className = 'row ' + (who==='me' ? 'me' : '');
      const b = document.createElement('div');
      b.className = 'bubble ' + (who==='me' ? 'me' : 'bot');
      b.textContent = text;
      row.appendChild(b);
      chat.appendChild(row);           // se agrega al final
      scrollToBottomSmooth();
    }

    function addChips(options){
      if(!options?.length) return;
      const ct = document.createElement('div');
      ct.className = 'chips';
      options.forEach(op=>{
        const c = document.createElement('button');
        c.className = 'chip';
        c.textContent = op;
        c.onclick = ()=>{ input.value = op; sendMessage(); };
        ct.appendChild(c);
      });
      chat.appendChild(ct);
      scrollToBottomSmooth();
    }

    // Mantener visible al abrir teclado (iOS/Android)
    const vv = window.visualViewport;
    function onViewportChange(){
      // reajusta altura útil y baja al final
      if(vv){
        // ajusta la altura del contenedor principal al alto visible
        app.style.height = vv.height + 'px';
      }
      scrollToBottomSmooth();
    }
    if(vv){
      vv.addEventListener('resize', onViewportChange);
      vv.addEventListener('scroll', onViewportChange);
    }
    window.addEventListener('orientationchange', onViewportChange);
    input.addEventListener('focus', ()=> setTimeout(scrollToBottomSmooth, 50));

    // ===== Backend (simulado) =====
    const USE_N8N = false;
    const API_URL = "https://TU_N8N_HTTPS/webhook/chat-salon";

    function getSession(){
      let s = localStorage.getItem('salon_session');
      if(!s){ s = 'sess_' + Math.random().toString(36).slice(2); localStorage.setItem('salon_session', s); }
      return s;
    }

    async function sendMessage(){
      const text = input.value.trim();
      if(!text) return;
      addMsg(text, 'me');
      input.value=''; input.focus();

      if(USE_N8N){
        try{
          const res = await fetch(API_URL, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ sessionId:getSession(), message:text })
          });
          const data = await res.json(); // {reply, options?}
          if(data.reply) addMsg(data.reply, 'bot');
          if(data.options) addChips(data.options);
        }catch(e){
          addMsg('Perdón, hubo un problema. Intenta de nuevo.', 'bot');
        }
      } else {
        // demo
        setTimeout(()=> addMsg('Respuesta automática: ' + text, 'bot'), 250);
      }
    }

    send.onclick = sendMessage;
    input.addEventListener('keydown', e=>{ if(e.key==='Enter') sendMessage(); });

    // Bienvenida
    addMsg('¡Hola! Soy tu asistente. ¿Reservar, ver servicios o reprogramar?', 'bot');
    addChips(['Reservar manicure','Ver servicios','Reprogramar mi cita']);
  </script>
</body>
</html>
