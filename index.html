<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Chat Soporte</title>
  <style>
    /* ===== Tema (oscuro por defecto) ===== */
    :root{
      --bg:#0b0b0c; --surface:#111214; --ink:#e5e7eb; --muted:#a1a1aa; --accent:#1d4ed8;
      --bot:#1a1b1e; --user:#2563eb; --border:#232428;
    }
    @media (prefers-color-scheme: light) {
      :root{
        --bg:#f7f7fb; --surface:#ffffff; --ink:#111827; --muted:#6b7280; --accent:#2563eb;
        --bot:#f3f4f6; --user:#2563eb; --border:#e5e7eb;
      }
    }
    .light{
      --bg:#f7f7fb; --surface:#ffffff; --ink:#111827; --muted:#6b7280; --accent:#2563eb;
      --bot:#f3f4f6; --user:#2563eb; --border:#e5e7eb;
    }
    .dark{
      --bg:#0b0b0c; --surface:#111214; --ink:#e5e7eb; --muted:#a1a1aa; --accent:#1d4ed8;
      --bot:#1a1b1e; --user:#2563eb; --border:#232428;
    }

    /* ===== Layout base ===== */
    html, body { height: 100%; }
    body{
      margin: 0;
      background: var(--bg);
      color: var(--ink);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      overscroll-behavior-y: contain;
    }
    .app{
      height: 100svh;                 /* alto real en móviles (fallback: los navegadores usan 100vh) */
      display: flex;
      flex-direction: column;
      max-width: 800px;
      margin: 0 auto;
      box-sizing: border-box;
      padding-bottom: calc(var(--foot-h,72px) + env(safe-area-inset-bottom)); /* reserva espacio del footer fixed */
    }
    .head{
      display: flex; justify-content: space-between; align-items: center;
      padding: 14px 16px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 10;
    }
    .title{ font-weight: 700; }
    .muted{ color: var(--muted); font-size: 12px; }
    .toggle{
      border:1px solid var(--border); background: transparent; color: var(--ink);
      border-radius: 999px; padding: 6px 12px; font-weight:600; cursor:pointer;
    }

    .chat{
      flex: 1;
      overflow-y: auto;
      padding: 12px 12px 8px 12px;
      /* mejor tacto en iOS, y nosotros manejamos el “autoscroll” por JS */
      -webkit-overflow-scrolling: touch;
      scroll-behavior: auto;
      background: var(--bg);
    }
    .row{ display:flex; margin: 6px 0; }
    .me{ justify-content: flex-end; }
    .bubble{
      max-width: 82%;
      padding: 12px 14px;
      border-radius: 16px;
      font-size: 16px;
      line-height: 1.4;
      word-wrap: break-word;
      border: 1px solid var(--border);
    }
    .bubble.bot{
      background: var(--bot); color: var(--ink);
      border-bottom-left-radius: 6px;
    }
    .bubble.me{
      background: var(--user); color: #fff;
      border-bottom-right-radius: 6px;
    }

    .chips{
      display:flex; flex-wrap: wrap; gap:8px; margin: 6px 4px 0 4px;
    }
    .chip{
      border:1px solid var(--border); color: var(--ink);
      background: transparent; border-radius: 999px;
      padding: 8px 12px; font-size: 14px; cursor: pointer;
    }

    /* Footer FIXED (para que nunca quede detrás del teclado) */
    .foot{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 0;
      width: min(100%, 800px);
      background: var(--surface);
      border-top: 1px solid var(--border);
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom)) 10px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      z-index: 20;
      box-sizing: border-box;
    }
    .in{
      width: 100%;
      font-size: 18px;                 /* tu tamaño original */
      padding: 14px 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      outline: none;
      color: var(--ink);
      background: transparent;
    }
    .btn{
      font-size: 17px;                 /* tu tamaño original */
      font-weight: 700;
      padding: 14px 18px;
      border-radius: 12px;
      border: none;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
    }
    .btn:active{ transform: translateY(1px); }
  </style>
</head>
<body>
  <div class="app">
    <div class="head">
      <div>
        <div class="title">Chat del Salón</div>
        <div class="muted">Agenda, reprograma y resuelve dudas</div>
      </div>
      <button id="toggle" class="toggle">☾ / ☀︎</button>
    </div>

    <div id="chat" class="chat"></div>
  </div>

  <div class="foot" id="foot">
    <input id="input" class="in" placeholder="Escribe tu mensaje…" inputmode="latin" autocomplete="off" />
    <button id="send" class="btn">Enviar</button>
  </div>

  <script>
    // ========= Tema claro/oscuro =========
    const saved = localStorage.getItem('theme');
    if(saved){ document.body.classList.add(saved); }
    else {
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      document.body.classList.add(prefersDark ? 'dark' : 'light');
    }
    document.getElementById('toggle').onclick = ()=>{
      const isLight = document.body.classList.contains('light');
      document.body.classList.remove(isLight ? 'light' : 'dark');
      document.body.classList.add(isLight ? 'dark' : 'light');
      localStorage.setItem('theme', isLight ? 'dark' : 'light');
    };

    // ========= Medir footer y reservar espacio (evita huecos) =========
    const foot = document.getElementById('foot');
    const app  = document.querySelector('.app');
    function setFootVar(){
      const h = foot.getBoundingClientRect().height;
      document.documentElement.style.setProperty('--foot-h', h + 'px');
    }
    setFootVar();
    new ResizeObserver(setFootVar).observe(foot);

    // ========= Chat helpers =========
    const chat = document.getElementById('chat');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('send');

    function scrollToBottom(){
      // doble RAF para que Safari/Android no “salte” arriba
      requestAnimationFrame(()=> {
        chat.scrollTop = chat.scrollHeight;
        requestAnimationFrame(()=> chat.scrollTop = chat.scrollHeight);
      });
    }
    function addMsg(text, who='bot'){
      const row = document.createElement('div');
      row.className = 'row ' + (who==='me' ? 'me' : '');
      const b = document.createElement('div');
      b.className = 'bubble ' + (who==='me' ? 'me' : 'bot');
      b.textContent = text;
      row.appendChild(b);
      chat.appendChild(row);          // SIEMPRE al final
      scrollToBottom();
    }
    function addChips(options){
      if(!options?.length) return;
      const ct = document.createElement('div');
      ct.className = 'chips';
      options.forEach(op=>{
        const c = document.createElement('button');
        c.className = 'chip';
        c.textContent = op;
        c.onclick = ()=>{ input.value = op; send(); };
        ct.appendChild(c);
      });
      chat.appendChild(ct);
      scrollToBottom();
    }

    // Mantener visible con teclado (iOS/Android)
    const vv = window.visualViewport;
    function onViewportChange(){
      if(vv){ app.style.height = vv.height + 'px'; } // usa alto visible real
      scrollToBottom();
    }
    if(vv){
      vv.addEventListener('resize', onViewportChange);
      vv.addEventListener('scroll', onViewportChange);
    }
    window.addEventListener('orientationchange', onViewportChange);
    input.addEventListener('focus', ()=> setTimeout(scrollToBottom, 50));

    // ========= Backend (simulado por ahora) =========
    const USE_N8N = false;
    const API_URL = "https://TU_N8N_HTTPS/webhook/chat-salon"; // reemplaza cuando esté listo

    async function send(){
      const text = input.value.trim();
      if(!text) return;
      addMsg(text, 'me');
      input.value = ''; input.focus();

      if(USE_N8N){
        try{
          const res = await fetch(API_URL, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ sessionId: getSession(), message: text })
          });
          const data = await res.json(); // {reply, options?}
          if(data.reply) addMsg(data.reply, 'bot');
          if(data.options) addChips(data.options);
        }catch(e){
          addMsg('Perdón, hubo un problema. Intenta de nuevo.', 'bot');
        }
      } else {
        setTimeout(()=> addMsg('Respuesta automática: ' + text, 'bot'), 250);
      }
    }

    function getSession(){
      let s = localStorage.getItem('salon_session');
      if(!s){ s = 'sess_' + Math.random().toString(36).slice(2); localStorage.setItem('salon_session', s); }
      return s;
    }

    // Enviar con botón y con Enter
    sendBtn.onclick = send;
    input.addEventListener('keydown', e=>{ if(e.key === 'Enter') send(); });

    // Mensaje inicial
    addMsg('¡Hola! Soy tu asistente. ¿Reservar, ver servicios o reprogramar?', 'bot');
    addChips(['Reservar manicure','Ver servicios','Reprogramar mi cita']);
  </script>
</body>
</html>
