<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Chat Soporte</title>
  <style>
    :root{
      --bg:#0b0b0c; --surface:#111214; --ink:#e5e7eb; --muted:#a1a1aa; --accent:#1d4ed8;
      --bot:#1a1b1e; --user:#2563eb; --border:#232428;
      --kb: 0px;        /* altura del teclado calculada en JS */
      --foot-h: 72px;   /* altura del footer (se mide en JS) */
    }
    @media (prefers-color-scheme: light) {
      :root{
        --bg:#f7f7fb; --surface:#ffffff; --ink:#111827; --muted:#6b7280; --accent:#2563eb;
        --bot:#f3f4f6; --user:#2563eb; --border:#e5e7eb;
      }
    }
    .light{
      --bg:#f7f7fb; --surface:#ffffff; --ink:#111827; --muted:#6b7280; --accent:#2563eb;
      --bot:#f3f4f6; --user:#2563eb; --border:#e5e7eb;
    }
    .dark{
      --bg:#0b0b0c; --surface:#111214; --ink:#e5e7eb; --muted:#a1a1aa; --accent:#1d4ed8;
      --bot:#1a1b1e; --user:#2563eb; --border:#232428;
    }

    html, body { height: 100%; }
    body{
      margin: 0; background: var(--bg); color: var(--ink);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      overscroll-behavior-y: contain;
    }

    /* Contenedor ocupando la pantalla completa (más robusto que 100vh) */
    .app{
      position: fixed; inset: 0;
      display: flex; flex-direction: column;
      max-width: 800px; margin: 0 auto;
      padding-top: 58px; /* espacio del header fijo */
      padding-bottom: calc(var(--foot-h) + var(--kb)); /* reserva footer + teclado */
      box-sizing: border-box;
    }

    /* Header fijo */
    .head{
      position: fixed; left: 50%; transform: translateX(-50%);
      top: 0; width: min(100%, 800px);
      display: flex; justify-content: space-between; align-items: center;
      padding: 14px 16px; background: var(--surface);
      border-bottom: 1px solid var(--border); z-index: 20;
      box-sizing: border-box;
    }
    .title{ font-weight: 700; }
    .muted{ color: var(--muted); font-size: 12px; }
    .toggle{
      border:1px solid var(--border); background: transparent; color: var(--ink);
      border-radius: 999px; padding: 6px 12px; font-weight:600; cursor:pointer;
    }

    /* Área del chat: siempre muestra lo último abajo */
    .chat{
      flex: 1; overflow-y: auto; padding: 12px;
      display: flex; flex-direction: column;
      -webkit-overflow-scrolling: touch; scroll-behavior: auto;
      background: var(--bg);
      border-left:1px solid var(--border); border-right:1px solid var(--border);
    }
    .row{ display:flex; margin: 6px 0; }
    .me{ justify-content: flex-end; }
    .bubble{
      max-width: 82%; padding: 12px 14px; border-radius: 16px;
      font-size: 16px; line-height: 1.4; word-wrap: break-word;
      border: 1px solid var(--border);
    }
    .bubble.bot{ background: var(--bot); color: var(--ink); border-bottom-left-radius: 6px; }
    .bubble.me{ background: var(--user); color: #fff; border-bottom-right-radius: 6px; }

    .chips{ display:flex; flex-wrap: wrap; gap:8px; margin: 6px 4px 0 4px; }
    .chip{
      border:1px solid var(--border); color: var(--ink);
      background: transparent; border-radius: 999px;
      padding: 8px 12px; font-size: 14px; cursor: pointer;
    }

    /* Footer fijo: lo movemos verticalmente con --kb cuando sale el teclado */
    .foot{
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: calc(var(--kb)); width: min(100%, 800px);
      background: var(--surface); border-top:1px solid var(--border);
      padding: 10px 10px max(10px, env(safe-area-inset-bottom));
      display: grid; grid-template-columns: 1fr auto; gap: 8px; z-index: 30;
      box-sizing: border-box;
    }
    .in{
      width: 100%; font-size: 18px; padding: 14px 16px;
      border-radius: 12px; border: 1px solid var(--border);
      outline: none; color: var(--ink); background: transparent;
    }
    .btn{
      font-size: 17px; font-weight: 700; padding: 14px 18px;
      border-radius: 12px; border: none; background: var(--accent); color: #fff; cursor: pointer;
    }
    .btn:active{ transform: translateY(1px); }
  </style>
</head>
<body>
  <div class="head">
    <div>
      <div class="title">Chat del Salón</div>
      <div class="muted">Agenda, reprograma y resuelve dudas</div>
    </div>
    <button id="toggle" class="toggle">☾ / ☀︎</button>
  </div>

  <div class="app">
    <div id="chat" class="chat"></div>
  </div>

  <div class="foot" id="foot">
    <input id="input" class="in" placeholder="Escribe tu mensaje…" autocomplete="off" />
    <button id="send" class="btn">Enviar</button>
  </div>

  <script>
    // ===== Tema claro/oscuro =====
    const saved = localStorage.getItem('theme');
    if(saved){ document.body.classList.add(saved); }
    else document.body.classList.add(matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    document.getElementById('toggle').onclick = ()=>{
      const light = document.body.classList.contains('light');
      document.body.classList.toggle('light', !light);
      document.body.classList.toggle('dark', light);
      localStorage.setItem('theme', light ? 'dark' : 'light');
    };

    // ===== medir altura del footer y del teclado =====
    const foot = document.getElementById('foot');
    const chat = document.getElementById('chat');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('send');

    const setFootVars = ()=>{
      const h = Math.ceil(foot.getBoundingClientRect().height);
      document.documentElement.style.setProperty('--foot-h', h + 'px');
    };
    setFootVars();
    new ResizeObserver(setFootVars).observe(foot);

    // calcula altura del teclado y la aplica a --kb (soporta iOS/Android)
    const vv = window.visualViewport;
    const setKb = ()=>{
      if(!vv){ document.documentElement.style.setProperty('--kb','0px'); return; }
      const keyboard = Math.max(0, (window.innerHeight - vv.height - vv.offsetTop));
      document.documentElement.style.setProperty('--kb', keyboard + 'px');
      // tras mover el footer, baja al final
      scrollToBottom();
    };
    if(vv){
      vv.addEventListener('resize', setKb);
      vv.addEventListener('scroll', setKb);
    }
    window.addEventListener('orientationchange', ()=> setTimeout(setKb, 50));
    input.addEventListener('focus', ()=> setTimeout(()=>{ setKb(); scrollToBottom(); }, 50));

    // ===== utilidades de chat =====
    function scrollToBottom(){
      // doble RAF para asegurar que el DOM terminó de pintar
      requestAnimationFrame(()=> {
        chat.scrollTop = chat.scrollHeight;
        requestAnimationFrame(()=> chat.scrollTop = chat.scrollHeight);
      });
    }

    function addMsg(text, who='bot'){
      const row = document.createElement('div');
      row.className = 'row ' + (who==='me' ? 'me' : '');
      const b = document.createElement('div');
      b.className = 'bubble ' + (who==='me' ? 'me' : 'bot');
      b.textContent = text;
      row.appendChild(b);
      chat.appendChild(row);    // SIEMPRE al final
      scrollToBottom();         // y luego bajamos
    }

    function addChips(options){
      if(!options?.length) return;
      const ct = document.createElement('div');
      ct.className = 'chips';
      options.forEach(op=>{
        const c = document.createElement('button');
        c.className = 'chip';
        c.textContent = op;
        c.onclick = ()=>{ input.value = op; send(); };
        ct.appendChild(c);
      });
      chat.appendChild(ct);
      scrollToBottom();
    }

    // ===== backend simulado por ahora =====
    const USE_N8N = false;
    const API_URL  = "https://TU_N8N_HTTPS/webhook/chat-salon"; // cambia cuando conectes n8n

    function getSession(){
      let s = localStorage.getItem('salon_session');
      if(!s){ s='sess_'+Math.random().toString(36).slice(2); localStorage.setItem('salon_session', s); }
      return s;
    }

    async function send(){
      const text = input.value.trim();
      if(!text) return;
      addMsg(text, 'me');
      input.value = ''; input.focus();

      if(USE_N8N){
        try{
          const res = await fetch(API_URL, {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ sessionId:getSession(), message:text })
          });
          const data = await res.json(); // {reply, options?}
          if(data.reply) addMsg(data.reply, 'bot');
          if(data.options) addChips(data.options);
        }catch(e){
          addMsg('Perdón, hubo un problema. Intenta de nuevo.', 'bot');
        }
      } else {
        setTimeout(()=> addMsg('Respuesta automática: ' + text, 'bot'), 220);
      }
    }

    sendBtn.onclick = send;
    input.addEventListener('keydown', e=>{ if(e.key==='Enter') send(); });

    // mensaje inicial
    addMsg('¡Hola! Soy tu asistente que ya me canse. ¿Reservar, ver servicios o reprogramar?', 'bot');
    addChips(['Reservar manicure','Ver servicios','Reprogramar mi cita']);

    // inicializa medidas (por si el navegador tarda en dar tamaños correctos)
    setTimeout(()=>{ setFootVars(); setKb(); scrollToBottom(); }, 50);
  </script>
</body>
</html>
