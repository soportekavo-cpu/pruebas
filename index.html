<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Chat del Salón</title>
  <style>
    /* ===== Tema (oscuro por defecto) ===== */
    :root{
      --bg:#0b0b0c; --surface:#111214; --ink:#e5e7eb; --muted:#a1a1aa; --accent:#2563eb;
      --bot:#1a1b1e; --user:#2563eb; --border:#232428;
    }
    @media (prefers-color-scheme: light) {
      :root{
        --bg:#f7f7fb; --surface:#ffffff; --ink:#111827; --muted:#6b7280; --accent:#2563eb;
        --bot:#f3f4f6; --user:#2563eb; --border:#e5e7eb;
      }
    }
    .light{
      --bg:#f7f7fb; --surface:#ffffff; --ink:#111827; --muted:#6b7280; --accent:#2563eb;
      --bot:#f3f4f6; --user:#2563eb; --border:#e5e7eb;
    }
    .dark{
      --bg:#0b0b0c; --surface:#111214; --ink:#e5e7eb; --muted:#a1a1aa; --accent:#2563eb;
      --bot:#1a1b1e; --user:#2563eb; --border:#232428;
    }

    /* ===== Layout base ===== */
    html, body { height: 100%; }
    body{
      margin: 0;
      background: var(--bg);
      color: var(--ink);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    .app{
      /* 100svh = altura útil “pequeña” (barra/teclado) compatible con iOS/Android */
      height: 100svh;
      display: flex;
      flex-direction: column;
      max-width: 800px;
      margin: 0 auto;
    }
    .head{
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px 14px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 10;
    }
    .title{ font-weight: 700; }
    .muted{ color: var(--muted); font-size: 12px; }
    .toggle{
      border:1px solid var(--border); background: transparent; color: var(--ink);
      border-radius: 999px; padding: 6px 12px; font-weight:600; cursor:pointer;
    }

    .chat{
      flex: 1;
      overflow-y: auto;
      padding: 10px 10px 6px 10px;
      scroll-behavior: smooth;
      background: var(--bg);

      /* Asegura columna “normal” (arriba→abajo) pero scrolleamos al final */
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .row{ display:flex; }
    .me{ justify-content: flex-end; }
    .bubble{
      max-width: 82%;
      padding: 10px 12px;
      border-radius: 16px;
      font-size: 15px;         /* ← un poco más pequeño */
      line-height: 1.4;
      word-wrap: break-word;
      border: 1px solid var(--border);
    }
    .bubble.bot{
      background: var(--bot); color: var(--ink);
      border-bottom-left-radius: 6px;
    }
    .bubble.me{
      background: var(--user); color: #fff;
      border-bottom-right-radius: 6px;
    }

    .chips{
      display:flex; flex-wrap: wrap; gap:8px; margin: 2px 2px 0 2px;
    }
    .chip{
      border:1px solid var(--border); color: var(--ink);
      background: transparent; border-radius: 999px;
      padding: 6px 10px; font-size: 13px; cursor: pointer;
    }

    .foot{
      background: var(--surface);
      border-top: 1px solid var(--border);
      padding: 8px 8px calc(8px + env(safe-area-inset-bottom)) 8px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      position: sticky; bottom: 0; z-index: 10;
    }
    .in{
      width: 100%;
      font-size: 16px;           /* 16px evita el zoom automático en iOS */
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      outline: none;
      color: var(--ink);
      background: transparent;
    }
    .btn{
      font-size: 16px;           /* más pequeño que antes */
      font-weight: 700;
      padding: 12px 16px;
      border-radius: 12px;
      border: none;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
    }
    .btn:active{ transform: translateY(1px); }
  </style>
</head>
<body>
  <div class="app">
    <div class="head">
      <div>
        <div class="title">Chat del Salón</div>
        <div class="muted">Agenda, reprograma y resuelve dudas</div>
      </div>
      <button id="toggle" class="toggle">☾ / ☀︎</button>
    </div>

    <div id="chat" class="chat">
      <!-- ancla al final para auto-scroll -->
      <div id="end-anchor" style="height:1px;"></div>
    </div>

    <div class="foot">
      <input id="input" class="in" placeholder="Escribe tu mensaje…" inputmode="latin" autocomplete="off" />
      <button id="send" class="btn">Enviar</button>
    </div>
  </div>

  <script>
    // ========= Tema claro/oscuro =========
    const saved = localStorage.getItem('theme');
    if(saved){ document.body.classList.add(saved); }
    else {
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      document.body.classList.add(prefersDark ? 'dark' : 'light');
    }
    document.getElementById('toggle').onclick = ()=>{
      const isLight = document.body.classList.contains('light');
      document.body.classList.remove(isLight ? 'light' : 'dark');
      document.body.classList.add(isLight ? 'dark' : 'light');
      localStorage.setItem('theme', isLight ? 'dark' : 'light');
    };

    // ========= Chat helpers =========
    const chat = document.getElementById('chat');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const endAnchor = document.getElementById('end-anchor');

    function scrollToBottom(){
      // Ancla invisible: funciona mejor que cambiar scrollTop en Safari/Android
      endAnchor.scrollIntoView({behavior:'smooth', block:'end'});
    }
    function addMsg(text, who='bot'){
      const row = document.createElement('div');
      row.className = 'row ' + (who==='me' ? 'me' : '');
      const b = document.createElement('div');
      b.className = 'bubble ' + (who==='me' ? 'me' : 'bot');
      b.textContent = text;
      row.appendChild(b);

      // insertamos justo ANTES del ancla, para que el ancla permanezca al final
      chat.insertBefore(row, endAnchor);
      scrollToBottom();
    }
    function addChips(options){
      if(!options?.length) return;
      const ct = document.createElement('div');
      ct.className = 'chips';
      options.forEach(op=>{
        const c = document.createElement('button');
        c.className = 'chip';
        c.textContent = op;
        c.onclick = ()=>{ input.value = op; send(); };
        ct.appendChild(c);
      });
      chat.insertBefore(ct, endAnchor);
      scrollToBottom();
    }

    // Mantén visible al mostrar teclado (iOS/Android)
    const vv = window.visualViewport;
    const onVVChange = ()=> setTimeout(scrollToBottom, 50);
    if(vv){
      vv.addEventListener('resize', onVVChange);
      vv.addEventListener('scroll', onVVChange);
    } else {
      window.addEventListener('resize', onVVChange);
    }
    input.addEventListener('focus', ()=> setTimeout(scrollToBottom, 50));

    // ========= Backend (simulado por ahora) =========
    const USE_N8N = false;
    const API_URL = "https://TU_N8N_HTTPS/webhook/chat-salon"; // reemplaza cuando esté listo

    async function send(){
      const text = input.value.trim();
      if(!text) return;
      addMsg(text, 'me');
      input.value = ''; input.focus();

      if(USE_N8N){
        try{
          const res = await fetch(API_URL, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ sessionId: getSession(), message: text })
          });
          const data = await res.json(); // {reply, options?}
          if(data.reply) addMsg(data.reply, 'bot');
          if(data.options) addChips(data.options);
        }catch(e){
          addMsg('Perdón, hubo un problema. Intenta de nuevo.', 'bot');
        }
      } else {
        // Eco de prueba
        setTimeout(()=> addMsg('Respuesta automática: ' + text, 'bot'), 250);
      }
    }

    function getSession(){
      let s = localStorage.getItem('salon_session');
      if(!s){ s = 'sess_' + Math.random().toString(36).slice(2); localStorage.setItem('salon_session', s); }
      return s;
    }

    // Enviar con botón y con Enter
    sendBtn.onclick = send;
    input.addEventListener('keydown', e=>{ if(e.key === 'Enter') send(); });

    // Mensaje inicial
    addMsg('¡Hola! Soy tu asistente. ¿Reservar, ver servicios o reprogramar?', 'bot');
    addChips(['Reservar manicure','Ver servicios','Reprogramar mi cita']);
  </script>
</body>
</html>
